<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyBot - CODECADE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'VT323', monospace; background: #000 url('/assets/images/background.jpg') center center / cover no-repeat fixed; }
        .text-glow-pink { color: #ff1493; text-shadow: 0 0 5px #ff1493, 0 0 10px #ff1493; }
        .text-glow-cyan { color: #00ffff; text-shadow: 0 0 5px #00ffff; }
        .retro-panel { background-color: #4b2e72; border: 4px solid #9932cc; box-shadow: 0 0 15px #9932cc; }
        .chat-message { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen text-white">
    <div class="bg-purple-900/60 min-h-screen p-8">
        <div class="max-w-6xl mx-auto">
            <div class="flex items-center mb-8">
                <a href="index.html" class="text-2xl text-blue-400 hover:text-blue-300 mr-4">‚Üê Back</a>
                <h1 class="text-5xl font-bold text-glow-pink">ü§ñ StudyBot</h1>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Chat Panel -->
                <div class="retro-panel rounded-xl p-6">
                    <h2 class="text-3xl text-glow-cyan mb-4">Chat with StudyBot</h2>
                    <div id="chatBox" class="bg-black/50 rounded-lg p-4 h-96 overflow-y-auto mb-4 space-y-3">
                        <div class="chat-message text-cyan-400">
                            <strong>StudyBot:</strong> Hi! I'm StudyBot. I can help you create personalized study plans. Tell me about your exam!
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="chatInput" placeholder="Type your message..." 
                               class="flex-1 bg-gray-800 border border-purple-500 rounded px-4 py-2 text-white"
                               onkeypress="if(event.key==='Enter') sendChat()">
                        <button onclick="sendChat()" class="bg-pink-600 hover:bg-pink-700 px-6 py-2 rounded font-bold">Send</button>
                    </div>
                </div>

                <!-- Quick Plan Creator -->
                <div class="retro-panel rounded-xl p-6">
                    <h2 class="text-3xl text-glow-cyan mb-4">Quick Plan Creator</h2>
                    <div class="space-y-4">
                        <input type="text" id="examName" placeholder="Exam Name (e.g., DSA Midsem)" 
                               class="w-full bg-gray-800 border border-purple-500 rounded px-4 py-2 text-white">
                        
                        <div class="grid grid-cols-2 gap-4">
                            <input type="date" id="startDate" 
                                   class="bg-gray-800 border border-purple-500 rounded px-4 py-2 text-white">
                            <input type="date" id="examDate" 
                                   class="bg-gray-800 border border-purple-500 rounded px-4 py-2 text-white">
                        </div>
                        
                        <input type="number" id="dailyHours" placeholder="Daily Hours (e.g., 3)" min="1" max="12"
                               class="w-full bg-gray-800 border border-purple-500 rounded px-4 py-2 text-white">
                        
                        <div id="topicsContainer" class="space-y-2">
                            <div class="flex gap-2">
                                <input type="text" placeholder="Topic (e.g., Arrays)" class="flex-1 bg-gray-800 border border-purple-500 rounded px-4 py-2 text-white topic-name">
                                <select class="bg-gray-800 border border-purple-500 rounded px-4 py-2 text-white topic-difficulty">
                                    <option value="easy">Easy</option>
                                    <option value="medium">Medium</option>
                                    <option value="hard">Hard</option>
                                </select>
                                <input type="number" placeholder="Weight" min="1" max="100" value="10" class="w-20 bg-gray-800 border border-purple-500 rounded px-4 py-2 text-white topic-weight">
                            </div>
                        </div>
                        
                        <button onclick="addTopic()" class="text-cyan-400 hover:text-cyan-300">+ Add Topic</button>
                        
                        <button onclick="createPlan()" class="w-full bg-pink-600 hover:bg-pink-700 px-6 py-3 rounded-lg text-2xl font-bold">
                            Generate Study Plan
                        </button>
                    </div>
                </div>
            </div>

            <!-- Plan Display -->
            <div id="planDisplay" class="retro-panel rounded-xl p-6 mt-6 hidden">
                <h2 class="text-3xl text-glow-cyan mb-4">Your Study Plan</h2>
                <div id="planContent" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        const username = localStorage.getItem('codecade_username') || 'guest_' + Date.now();

        async function sendChat() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            addChatMessage('You', message, 'text-green-400');
            input.value = '';

            try {
                const res = await fetch(`${API_BASE}/studybot/chat`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, message})
                });
                const data = await res.json();
                addChatMessage('StudyBot', data.reply, 'text-cyan-400');
                
                if (data.planPreview) {
                    displayPlanPreview(data.planPreview);
                }
            } catch (err) {
                addChatMessage('System', 'Error: ' + err.message, 'text-red-400');
            }
        }

        function addChatMessage(sender, message, color) {
            const chatBox = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = `chat-message ${color}`;
            div.innerHTML = `<strong>${sender}:</strong> ${message.replace(/\n/g, '<br>')}`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function addTopic() {
            const container = document.getElementById('topicsContainer');
            const div = document.createElement('div');
            div.className = 'flex gap-2';
            div.innerHTML = `
                <input type="text" placeholder="Topic" class="flex-1 bg-gray-800 border border-purple-500 rounded px-4 py-2 text-white topic-name">
                <select class="bg-gray-800 border border-purple-500 rounded px-4 py-2 text-white topic-difficulty">
                    <option value="easy">Easy</option>
                    <option value="medium">Medium</option>
                    <option value="hard">Hard</option>
                </select>
                <input type="number" placeholder="Weight" min="1" max="100" value="10" class="w-20 bg-gray-800 border border-purple-500 rounded px-4 py-2 text-white topic-weight">
                <button onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-300 px-2">‚úï</button>
            `;
            container.appendChild(div);
        }

        async function createPlan() {
            const examName = document.getElementById('examName').value;
            const startDate = document.getElementById('startDate').value;
            const examDate = document.getElementById('examDate').value;
            const dailyHours = parseInt(document.getElementById('dailyHours').value);

            const topicElements = document.querySelectorAll('#topicsContainer > div');
            const topics = Array.from(topicElements).map(el => ({
                name: el.querySelector('.topic-name').value,
                difficulty: el.querySelector('.topic-difficulty').value,
                weightage: parseInt(el.querySelector('.topic-weight').value)
            })).filter(t => t.name);

            if (!examName || !startDate || !examDate || !dailyHours || topics.length === 0) {
                alert('Please fill all fields and add at least one topic!');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/studybot/plan`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, examName, startDate, examDate, dailyHours, topics})
                });
                const data = await res.json();
                
                addChatMessage('StudyBot', data.message, 'text-cyan-400');
                displayFullPlan(data.plan);
            } catch (err) {
                alert('Error creating plan: ' + err.message);
            }
        }

        function displayFullPlan(plan) {
            const display = document.getElementById('planDisplay');
            const content = document.getElementById('planContent');
            
            let html = `
                <div class="bg-black/50 rounded-lg p-4 mb-4">
                    <h3 class="text-2xl text-pink-400 mb-2">${plan.examName}</h3>
                    <p class="text-xl">üìÖ ${plan.startDate} to ${plan.examDate} (${plan.totalDays} days)</p>
                    <p class="text-xl">‚è∞ ${plan.dailyHours} hours/day</p>
                </div>

                <div class="bg-black/50 rounded-lg p-4 mb-4">
                    <h3 class="text-2xl text-cyan-400 mb-3">üìö Topics</h3>
                    <div class="grid grid-cols-2 gap-2">
                        ${plan.topics.map(t => `
                            <div class="bg-purple-900/50 rounded p-2">
                                <span class="text-yellow-400">${t.name}</span>
                                <span class="text-gray-400 text-sm">(${t.difficulty}, weight: ${t.weightage})</span>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="bg-black/50 rounded-lg p-4 mb-4">
                    <h3 class="text-2xl text-cyan-400 mb-3">üéØ Phases</h3>
                    ${plan.phases.map((phase, i) => `
                        <div class="mb-3 border-l-4 border-pink-500 pl-4">
                            <h4 class="text-xl text-yellow-400">${phase.name}</h4>
                            <p class="text-gray-300">Days ${phase.startDay}-${phase.endDay}: ${phase.focus}</p>
                        </div>
                    `).join('')}
                </div>

                <div class="bg-black/50 rounded-lg p-4">
                    <h3 class="text-2xl text-cyan-400 mb-3">üìÖ First 3 Days Preview</h3>
                    ${plan.dailyPlan.slice(0, 3).map(day => `
                        <div class="mb-3 bg-purple-900/30 rounded p-3">
                            <h4 class="text-xl text-green-400">Day ${day.dayIndex} - ${day.date}</h4>
                            <ul class="list-disc list-inside text-gray-300">
                                ${day.tasks.map(task => `<li>${task}</li>`).join('')}
                            </ul>
                        </div>
                    `).join('')}
                    <p class="text-gray-400 text-center mt-2">... and ${plan.dailyPlan.length - 3} more days</p>
                </div>
            `;
            
            content.innerHTML = html;
            display.classList.remove('hidden');
            display.scrollIntoView({behavior: 'smooth'});
        }

        function displayPlanPreview(preview) {
            const display = document.getElementById('planDisplay');
            const content = document.getElementById('planContent');
            
            let html = `
                <div class="bg-black/50 rounded-lg p-4">
                    <h3 class="text-2xl text-cyan-400 mb-3">Plan Preview</h3>
                    <p class="text-xl mb-2">Total Days: ${preview.totalDays}</p>
                    ${preview.phases ? `
                        <div class="space-y-2">
                            ${preview.phases.map(p => `
                                <div class="border-l-4 border-pink-500 pl-3">
                                    <strong>${p.name}</strong>: Days ${p.startDay}-${p.endDay}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
            
            content.innerHTML = html;
            display.classList.remove('hidden');
        }

        // Set default dates
        window.onload = () => {
            const today = new Date();
            const nextMonth = new Date(today);
            nextMonth.setDate(today.getDate() + 30);
            
            document.getElementById('startDate').valueAsDate = today;
            document.getElementById('examDate').valueAsDate = nextMonth;
        };
    </script>
</body>
</html>
